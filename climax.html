<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åŸ‹ã¾ã‚‰ãªã„äºˆå®Ÿå·®ã®é—‡ - Final Chapter</title>
<style>
    /* â–¼â–¼â–¼ æœ€çµ‚ç« ï¼šé‹å‘½ã®ç²¾ç®— â–¼â–¼â–¼ */
    :root {
        --bg-color: #000;
        --text-color: #ccc;
        --accent-blue: #4a90e2;
        --accent-red: #b00;
        --accent-ghost: #0ff;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: "Yu Mincho", serif;
        line-height: 2.6;
        margin: 0;
        display: flex;
        justify-content: center;
        min-height: 100vh;
        overflow: hidden; /* èƒŒæ™¯ç”»åƒç”¨ */
    }

    /* === ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€  === */
    #layer-group {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; pointer-events: none;
    }
    #bg-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-size: cover; background-position: center;
        transition: opacity 1s ease; opacity: 0.4;
    }
    #cg-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; justify-content: center; align-items: center;
    }
    #cg-image {
        max-height: 90%; max-width: 90%;
        opacity: 0; transition: opacity 0.3s ease;
        filter: drop-shadow(0 0 20px #000);
    }

    #game-wrapper {
        width: 100%;
        max-width: 900px;
        height: 95vh;
        background-color: rgba(5, 5, 5, 0.85); /* åŠé€æ˜ */
        box-shadow: 0 0 100px rgba(0,0,0,1);
        display: flex;
        flex-direction: column;
        border: 1px solid #222;
        position: relative;
        overflow-y: auto;
    }

    /* ç”»é¢æºã‚Œæ¼”å‡º */
    @keyframes shake {
        0% { transform: translate(1px, 1px) rotate(0deg); }
        50% { transform: translate(-1px, 2px) rotate(-1deg); }
        100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .shake-effect { animation: shake 0.2s infinite; }

    #visual-stage {
        height: 200px;
        background-size: cover;
        background-position: center;
        display: flex; align-items: center; justify-content: center;
        border-bottom: 1px solid #222; position: relative; overflow: hidden;
        flex-shrink: 0;
        transition: background-image 0.5s ease;
    }
    #visual-stage::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(180deg, rgba(15,15,15,0.6) 0%, rgba(0,0,0,0.85) 100%);
        z-index: 1;
    }
    /* æŠ½è±¡çš„ã‚·ãƒ³ãƒœãƒ«ï¼ˆå´©å£Šã™ã‚‹å††ï¼‰ */
    #scene-symbol {
        width: 40px; height: 40px;
        border: 1px solid rgba(138,0,0,0.25);
        border-radius: 50%;
        position: relative;
        opacity: 0.4;
        z-index: 2;
    }
    #scene-symbol::before {
        content: ''; position: absolute;
        top: 0; left: 50%; transform: translateX(-50%);
        width: 1px; height: 100%;
        background: linear-gradient(180deg, rgba(138,0,0,0.3) 0%, transparent 100%);
    }
    #scene-symbol::after {
        content: ''; position: absolute;
        top: 50%; left: 0; transform: translateY(-50%);
        width: 100%; height: 1px;
        background: linear-gradient(90deg, transparent 0%, rgba(138,0,0,0.3) 50%, transparent 100%);
    }
    
    #final-popup {
        position: absolute; bottom: 30px; right: 30px; width: 350px;
        background: #000; border-left: 4px solid var(--accent-red);
        color: #fff; padding: 20px; font-family: sans-serif; font-size: 0.95rem;
        box-shadow: 0 0 30px var(--accent-red);
        opacity: 0; transform: translateY(50px); transition: all 1s;
        z-index: 10;
    }
    #final-popup.show { opacity: 1; transform: translateY(0); }

    #narrative-area { padding: 40px 60px; flex-grow: 1; font-size: 1.15rem; text-align: justify; }
    p { margin-bottom: 3em; opacity: 0; animation: fadeIn 1.5s forwards; }
    @keyframes fadeIn { to { opacity: 1; } }

    .highlight { color: var(--accent-red); font-weight: bold; }
    .name { color: var(--accent-blue); font-weight: bold; font-family: sans-serif; font-size: 0.9em; display: block; margin-bottom: 1em; }

    .ghost-voice { 
        color: var(--accent-ghost); font-family: monospace; 
        text-shadow: 0 0 10px rgba(0,255,255,0.6); 
        display: block; margin: 3em 0; padding: 20px; 
        border-left: 1px solid var(--accent-ghost); background: rgba(0,255,255,0.05);
    }

    .ending-card {
        margin-top: 50px; padding: 40px; border: 1px solid #333; text-align: center;
        opacity: 0; animation: fadeIn 3s forwards; animation-delay: 1s;
        background: rgba(0,0,0,0.8);
    }
    .end-title { font-size: 2rem; margin-bottom: 20px; letter-spacing: 0.2em; font-weight: bold; }

    #choices-container {
        padding: 50px 80px 100px;
        display: flex; flex-direction: column; gap: 25px;
        background: rgba(8,8,8,0.9); border-top: 1px solid #222;
    }
    button {
        background: rgba(17,17,17,0.9); color: #888; border: 1px solid #333;
        padding: 30px; text-align: left; font-family: "Yu Mincho", serif; font-size: 1.1rem;
        cursor: pointer; transition: all 0.5s;
    }
    button:hover { background: #300; color: #fff; border-color: #800; padding-left: 40px; }
    
    /* åˆ†å²è‰² */
    .btn-true { border-left: 4px solid var(--accent-blue); }
    .btn-bad { border-left: 4px solid #666; }
    .btn-dark { border-left: 4px solid var(--accent-red); }

</style>
</head>
<body>

<div id="layer-group">
    <div id="bg-layer"></div>
    <div id="cg-layer"><img id="cg-image" src="" alt=""></div>
</div>

<div id="game-wrapper">
    <div id="visual-stage">
        <div id="scene-symbol"></div>
        <div id="final-popup">
            <strong>Unknown User</strong><br>
            <span id="popup-msg">ãã®å¸­ã¯ã€åŸ‹ã¾ã£ã¦ã„ã¾ã™ã€‚</span>
        </div>
    </div>

    <div id="narrative-area"></div>
    <div id="choices-container"></div>
</div>

<script src="audio.js"></script>
<script>
    /* =========================================
       ã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡ (Audio & Image)
       ========================================= */
    // AudioEngine ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ãƒ™ãƒ¼ã‚¹ã®BGM/SE + MP3ï¼‰
    const audio = {
        currentBgm: "",
        
        playBgm: function(filename) {
            if(this.currentBgm === filename) return;
            this.currentBgm = filename;
            
            // MP3ãƒ™ãƒ¼ã‚¹BGM
            if(filename === "bgm_ending") {
                AudioEngine.playEndingTheme();
            } else if(filename === "bgm_confession") {
                AudioEngine.playConfessionTheme();
            }
            // ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ã‚¹ï¼ˆã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ï¼‰
            else if(filename === "bgm_clock" || filename === "bgm_office") {
                AudioEngine.playAmbience("office");
            } else if(filename === "bgm_tinnitus") {
                AudioEngine.playAmbience("tinnitus");
            } else if(filename === "bgm_abyss") {
                AudioEngine.playAmbience("abyss");
            }
            // ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼BGM
            else if(filename === "bgm_horror") {
                AudioEngine.playHorrorTheme();
            } else if(filename === "bgm_mystery") {
                AudioEngine.playMysteryTheme();
            } else if(filename === "bgm_chase") {
                AudioEngine.playChaseTheme();
            }
            else {
                console.log("Unknown BGM:", filename);
            }
        },
        stopBgm: function() {
            AudioEngine.stopMusic();
            this.currentBgm = "";
        },
        playSe: function(filename) {
            // ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼SE
            if(filename === "se_ping") {
                AudioEngine.playPing();
            } else if(filename === "se_glitch") {
                AudioEngine.playGlitch();
            } else if(filename === "se_slam") {
                AudioEngine.playSlam();
            } else if(filename === "se_execution") {
                AudioEngine.playExecution();
            } else if(filename === "se_impact") {
                AudioEngine.playImpact();
            } else if(filename === "se_heartbeat") {
                AudioEngine.playHeartbeat();
            } else if(filename === "se_shredder") {
                AudioEngine.playShredder();
            } else if(filename === "se_stamp") {
                AudioEngine.playStamp();
            } else {
                console.log("Unknown SE:", filename);
            }
        }
    };

    const visuals = {
        bg: document.getElementById("bg-layer"),
        cg: document.getElementById("cg-image"),
        
        setBg: function(filename) {
            if(!filename) return;
            this.bg.style.backgroundImage = `url('images/${filename}.jpg')`;
        },
        setCg: function(filename) {
            if(!filename) {
                this.cg.style.opacity = 0;
            } else {
                this.cg.src = `images/${filename}.png`;
                this.cg.style.opacity = 1;
            }
        }
    };

    // â–¼â–¼â–¼ ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ï¼ˆç”»åƒãƒ»éŸ³å£°çµ±åˆç‰ˆï¼‰ â–¼â–¼â–¼
    const scenes = {
        // ----------------------------------------------------------------
        // ç¬¬1ç« ï¼šå½ã‚Šã®å¹³ç©
        // ----------------------------------------------------------------
        start: {
            icon: "â˜•",
            bg: "bg_office_night",    // â˜…èƒŒæ™¯ï¼šã‚ªãƒ•ã‚£ã‚¹
            music: "bgm_clock",       // â˜…BGMï¼šå¹³ç©ãªç’°å¢ƒéŸ³
            text: `
                <span class="name">5æœˆ20æ—¥ 18:30 çµŒç†éƒ¨ãƒ•ãƒ­ã‚¢</span>
                <p>
                å­£ç¯€ã¯å·¡ã‚Šã€æ–°ç·‘ã®5æœˆã€‚<br>
                ç¤¾å†…ã‚’è¦†ã£ã¦ã„ãŸé‡è‹¦ã—ã„ç©ºæ°—ã¯ã€å˜˜ã®ã‚ˆã†ã«æ™´ã‚Œæ¸¡ã£ã¦ã„ãŸã€‚<br>
                çŠ¬é£¼å…ˆè¼©ã¯ã€Œä¸æ…®ã®äº‹æ•…ã€ã§å§¿ã‚’æ¶ˆã—ã€æ¨©ç”°éƒ¨é•·ã¯ã€Œæ€¥æ€§ã®å¿ƒè‡“ç™ºä½œã€ã§æ€¥æ­»ã—ãŸã€‚<br>
                ç¾å’²ã‚’æ­»ã«è¿½ã„ã‚„ã£ãŸå…ƒå‡¶ãŸã¡ã¯ã€ç‰©ç†çš„ãƒ»ç¤¾ä¼šçš„ã«æŠ¹æ®ºã•ã‚ŒãŸã®ã ã€‚
                </p>
                <p>
                ç§ã¯ã€ç¾å’²ã®ã€Œä»£ç†äººã€ã¨ã—ã¦ã€é™ã‹ã«æ¥­å‹™ã‚’ã“ãªã—ã¦ã„ãŸã€‚<br>
                å¾©è®ã¯çµ‚ã‚ã£ãŸã€‚ç¾å’²ã®ç„¡å¿µã¯æ™´ã‚‰ã›ãŸã¯ãšã ã€‚<br>
                ç§ã®å¿ƒã®ä¸­ã«ã¯å¸¸ã«å†·ãŸã„æ°·ã®ã‚ˆã†ãªå¡ŠãŒã‚ã‚‹ãŒã€æ—¥å¸¸ã¯ä¸æ€è­°ã¨å¹³ç©ã ã£ãŸã€‚<br>
                â€¦â€¦ãã†ã€ã‚ã®æ—¥ã¾ã§ã¯ã€‚
                </p>
                <p>
                ã€Œäºœä¹…æ–—å…ˆè¼©â€¦â€¦ã‚ã®ã€è©±ãŒã‚ã‚Šã¾ã™ã€
                </p>
                <p>
                çµŒç†éƒ¨ã®æ–°äººã€<span style="color:#b55; font-weight:bold;">å®®æœ¬ æ¢¨å¥ˆï¼ˆã¿ã‚„ã‚‚ã¨ ã‚Šãªï¼‰</span>ãŒã€ãŠãšãŠãšã¨ç§ã«è¿‘ã¥ã„ã¦ããŸã€‚<br>
                å½¼å¥³ã¯æ˜ã‚‹ãã€çœŸé¢ç›®ã§ã€ã©ã“ã‹ç”Ÿå‰ã®ç¾å’²ã‚’æ€ã‚ã›ã‚‹é›°å›²æ°—ã‚’æŒã£ã¦ã„ãŸã€‚<br>
                ç§ã¯å½¼å¥³ã«ä¿ƒã•ã‚Œã€äººç›®ã®ã¤ã‹ãªã„è³‡æ–™å®¤ã¸ã¨å‘ã‹ã£ãŸã€‚
                </p>
            `,
            choices: [
                { text: "è³‡æ–™å®¤ã¸ç§»å‹•ã™ã‚‹", next: "confession_scene" }
            ]
        },

        // ----------------------------------------------------------------
        // ç¬¬2ç« ï¼šå‘Šç™½
        // ----------------------------------------------------------------
        confession_scene: {
            icon: "ğŸ’Œ",
            bg: "bg_archive",        // â˜…èƒŒæ™¯ï¼šè³‡æ–™å®¤
            cg: "cg_misaki_smile",   // â˜…CGï¼šå¾®ç¬‘ã‚€ç¾å’²ã®æ€ã„å‡º
            music: "bgm_confession", // â˜…BGMï¼šå‘Šç™½ã®ãƒ†ãƒ¼ãƒ
            text: `
                <p>
                è³‡æ–™å®¤ã®é‡ã„æ‰‰ã‚’é–‰ã‚ã‚‹ã¨ã€å‘¨å›²ã®é›‘éŸ³ãŒã‹ãæ¶ˆã•ã‚ŒãŸã€‚<br>
                å¤ã³ãŸç´™ã®åŒ‚ã„ã¨ã€æ¢¨å¥ˆã®é«ªã‹ã‚‰é¦™ã‚‹æŸ”è»Ÿå‰¤ã®ç”˜ã„åŒ‚ã„ãŒæ··ã–ã‚Šåˆã†ã€‚<br>
                å½¼å¥³ã¯é ¬ã‚’èµ¤ã‚‰ã‚ã€ä¸Šç›®é£ã„ã§ç§ã‚’è¦‹ä¸Šã’ãŸã€‚
                </p>
                <p>
                ã€Œå…ˆè¼©ã€ãšã£ã¨è¦‹ã¦ã¾ã—ãŸã€‚<br>
                å¤§å¤‰ãªæ™‚æœŸãªã®ã«ã€æ–‡å¥ã‚‚è¨€ã‚ãšã€ä¸€äººã§çµŒç†éƒ¨ã‚’æ”¯ãˆã¦ã‚‹å…ˆè¼©ã‚’ã€‚<br>
                è¾›ã„ã“ã¨ãŒã‚ã£ãŸã¯ãšãªã®ã«ã€é€ƒã’ãšã«æˆ¦ã£ã¦ã‚‹å…ˆè¼©ã‚’ã€
                </p>
                <p>
                å½¼å¥³ã®æ‰‹ãŒã€èºŠèº‡ã„ãªãŒã‚‰ç§ã®è¢–ã‚’æ´ã‚€ã€‚<br>
                æ¸©ã‹ã„ã€‚<br>
                ãã‚Œã¯ã€æ°·ã®ã‚ˆã†ã«å†·ãˆåˆ‡ã£ãŸç§ã®ä¸–ç•Œã«ã¯å­˜åœ¨ã—ãªã„ã€ç”ŸããŸäººé–“ã®ä½“æ¸©ã ã£ãŸã€‚<br>
                ãã®ç†±ãŒã€è¢–å£ã‹ã‚‰ç§ã®è‚Œã¸ã¨ä¼ã‚ã£ã¦ãã‚‹ã€‚
                </p>
                <p>
                ã€Œç§ã€å…ˆè¼©ã®æ”¯ãˆã«ãªã‚ŠãŸã„ã‚“ã§ã™ã€‚<br>
                â€¦â€¦ç§ã˜ã‚ƒã€ç¾å’²ã•ã‚“ã®ä»£ã‚ã‚Šã«ã¯ãªã‚Œã¾ã›ã‚“ã‹ï¼Ÿã€
                </p>
                <p>
                ãã®è¨€è‘‰ã«ã€ç§ã®å¿ƒè‡“ãŒå¤§ããè·³ã­ãŸã€‚<br>
                ã€Œä»˜ãåˆã£ã¦ãã ã•ã„ã€‚å…ˆè¼©ã‚’ã€ä¸€äººã«ã—ãŸããªã„ã‚“ã§ã™ã€
                </p>
            `,
            choices: [
                { text: "å½¼å¥³ã®æ¸©ã‚‚ã‚Šã‚’å—ã‘å…¥ã‚Œã‚ˆã†ã¨ã™ã‚‹", next: "hesitation" }
            ]
        },

        hesitation: {
            icon: "ğŸ’“",
            bg: "bg_archive",
            text: `
                <p>
                ç›®ã®å‰ã«ã€ç§ãŒãšã£ã¨æ¬²ã—ã‹ã£ãŸã€Œæ™®é€šã®å¹¸ã›ã€ãŒã‚ã‚‹ã€‚<br>
                äº¡éœŠã«æ€¯ãˆã‚‹å¤œã‚‚ã€å¾©è®ã«æ‰‹ã‚’æŸ“ã‚ã‚‹ç½ªæ‚ªæ„Ÿã‚‚ãªã„ä¸–ç•Œã€‚<br>
                å½¼å¥³ã®æ‰‹ã‚’å–ã‚Œã°ã€ç§ã¯ã“ã¡ã‚‰ã®ä¸–ç•Œï¼ˆç”Ÿè€…ï¼‰ã«æˆ»ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚
                </p>
                <p>
                ã€Œæ¢¨å¥ˆã¡ã‚ƒã‚“â€¦â€¦ã‚ã‚ŠãŒã¨ã†ã€‚åƒ•ã§ã‚ˆã‘ã‚Œã°â€¦â€¦ã€
                </p>
                <p>
                ç§ã¯éœ‡ãˆã‚‹æ‰‹ã§ã€å½¼å¥³ã®æ‰‹ã‚’æ¡ã‚Šè¿”ãã†ã¨ã—ãŸã€‚<br>
                ãã†è¨€ã„ã‹ã‘ãŸã€ãã®æ™‚ã ã£ãŸã€‚
                </p>
            `,
            choices: [
                { text: "â€¦â€¦ï¼ï¼Ÿï¼ˆç•°å¤‰ï¼‰", next: "intrusion" }
            ]
        },

        // ----------------------------------------------------------------
        // ç¬¬3ç« ï¼šäº¡éœŠã®ä»‹å…¥
        // ----------------------------------------------------------------
        intrusion: {
            icon: "ğŸ“±",
            bg: "bg_archive",
            sound: "se_ping",  // â˜…SEï¼šé€šçŸ¥éŸ³
            music: "stop",     // â˜…BGMåœæ­¢
            text: `
                <p>
                <strong style="color:#b00; font-size:1.5rem;">ãƒ–ãƒ–ãƒ–ãƒ–ãƒ–ãƒ–ãƒƒï¼ï¼ï¼</strong>
                </p>
                <p>
                ç§ã®ã‚¹ãƒãƒ›ã§ã¯ãªã„ã€‚<br>
                æ¢¨å¥ˆã®ãƒã‚±ãƒƒãƒˆã«å…¥ã£ã¦ã„ã‚‹ã‚¹ãƒãƒ›ãŒã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸Šã§æš´ã‚Œã‚‹è™«ã®ã‚ˆã†ã«ç•°å¸¸ãªæŒ¯å‹•éŸ³ã‚’ç«‹ã¦ãŸã€‚<br>
                ã€Œãˆã£â€¦â€¦ï¼Ÿã€<br>
                å½¼å¥³ãŒæ…Œã¦ã¦å–ã‚Šå‡ºã™ã€‚ç”»é¢ã‚’è¦‹ãŸç¬é–“ã€å½¼å¥³ã®é¡”ã‹ã‚‰è¡€ã®æ°—ãŒå¼•ã„ãŸã€‚
                </p>
                <p>
                ã€Œä½•ã“ã‚Œâ€¦â€¦é€šçŸ¥ãŒã€æ­¢ã¾ã‚‰ãªã„â€¦â€¦ã€
                </p>
                <p>
                å½¼å¥³ã®ã‚¹ãƒãƒ›ç”»é¢ã‚’è¦—ãè¾¼ã‚€ã€‚<br>
                ãã“ã«ã¯ã€è¦‹è¦šãˆã®ã‚ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ãŒã€ç‹‚ã£ãŸã‚ˆã†ãªé€Ÿåº¦ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åãå‡ºã—ç¶šã‘ã¦ã„ãŸã€‚<br>
                Microsoft Teamsã€‚<br>
                å·®å‡ºäººï¼šUnknown Userã€‚
                </p>
            `,
            action: { popup: "ã‚½ãƒå¸­ãƒåŸ‹ãƒãƒƒãƒ†ã‚¤ãƒã‚¹<br>ã‚½ãƒå¸­ãƒåŸ‹ãƒãƒƒãƒ†ã‚¤ãƒã‚¹<br>æ³¥æ£’çŒ«<br>æ­»ãƒ" },
            choices: [
                { text: "éƒ¨å±‹ã®ç•°å¤‰ã«æ°—ã¥ã", next: "poltergeist" }
            ]
        },

        poltergeist: {
            icon: "ğŸ‘»",
            bg: "bg_archive",
            cg: "cg_misaki_ghost_dead", // â˜…CGï¼šæ­»ä½“ã®ç¾å’²ãŒå‡ºç¾
            action: { shake: true },
            sound: "se_glitch",         // â˜…SEï¼šãƒã‚°éŸ³
            music: "bgm_horror",        // â˜…BGMï¼šææ€–ã®ãƒ†ãƒ¼ãƒ
            text: `
                <p>
                <span class="ghost-voice">
                ã€æ³¥æ£’çŒ«ã€‚æ­»ãƒã€‚æ­»ãƒã€‚æ­»ãƒã€‚æ­»ãƒã€‚ã€
                </span>
                </p>
                <p>
                è³‡æ–™å®¤ã®ç©ºæ°—ãŒã€ç¬æ™‚ã«æ°·ç‚¹ä¸‹ã¾ã§ä¸‹ãŒã£ãŸã€‚<br>
                é ­ä¸Šã®è›å…‰ç¯ãŒæ¿€ã—ãæ˜æ»…ã—ã€ãƒãƒãƒãƒã¨ç«èŠ±ã‚’æ•£ã‚‰ã™ã€‚
                </p>
                <p>
                ã€Œãã‚ƒã‚ã£ï¼ï¼Ÿã€
                </p>
                <p>
                å·¨å¤§ãªã‚¹ãƒãƒ¼ãƒ«æ£šãŒã€è¦‹ãˆãªã„åŠ›ã«æŠ¼ã•ã‚Œã‚‹ã‚ˆã†ã«ã‚¬ã‚¿ã‚¬ã‚¿ã¨æºã‚Œå§‹ã‚ãŸã€‚<br>
                ç¾å’²ã ã€‚<br>
                å½¼å¥³ã¯æˆä»ãªã©ã—ã¦ã„ãªã‹ã£ãŸã€‚<br>
                ç§ã‚’ã€Œæ‰€æœ‰ç‰©ã€ã¨èªè­˜ã—ã€è¿‘ã¥ãå¥³ã‚’ç‰©ç†çš„ã«æ’é™¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã®ã ã€‚
                </p>
                <p>
                ã€Œå…ˆè¼©ã€åŠ©ã‘ã¦â€¦â€¦ï¼ã€
                </p>
            `,
            choices: [
                { text: "ã“ã®ã¾ã¾ã§ã¯æ¢¨å¥ˆãŒæ­»ã¬", next: "ultimatum" }
            ]
        },

        // ----------------------------------------------------------------
        // ç¬¬4ç« ï¼šæœ€çµ‚æ±ºæ–­
        // ----------------------------------------------------------------
        ultimatum: {
            icon: "âš–ï¸",
            bg: "bg_archive",
            cg: "cg_misaki_ghost_dead",
            music: "bgm_abyss", // â˜…BGMï¼šæ·±æ·µ
            text: `
                <p>
                <span class="highlight">ã‚®ã‚®ã‚®ã‚®ã‚®â€¦â€¦ãƒƒï¼</span>
                </p>
                <p>
                é‡‘å±ãŒæ‚²é³´ã‚’ä¸Šã’ã‚‹ã€‚<br>
                é«˜ã•2ãƒ¡ãƒ¼ãƒˆãƒ«ã‚’è¶…ãˆã‚‹æ›¸é¡æ£šãŒã€ã‚†ã£ãã‚Šã¨æ¢¨å¥ˆã®æ–¹ã¸å‚¾ã„ã¦ã„ãã€‚<br>
                å½¼å¥³ã¯è…°ã‚’æŠœã‹ã—ã€å‹•ã‘ãªã„ã€‚
                </p>
                <p>
                ç¾å’²ã®æ€¨å¿µã‚’é®ã‚ã‚‹æ–¹æ³•ã¯ã€ç§ã«ã¯åˆ†ã‹ã£ã¦ã„ãŸã€‚<br>
                å½¼å¥³ï¼ˆç¾å’²ï¼‰ã¸ã®ã€Œçµ¶å¯¾çš„ãªå¿ èª ã€ã‚’ç¤ºã™ã“ã¨ã€‚<br>
                ã¤ã¾ã‚Šã€ç›®ã®å‰ã®æ–°ã—ã„å¹¸ã›ï¼ˆæ¢¨å¥ˆï¼‰ã‚’ã€ç§ã®æ‰‹ã§ç ´å£Šã™ã‚‹ã“ã¨ã ã€‚
                </p>
                <p>
                ã©ã†ã™ã‚‹ï¼Ÿ<br>
                ç¾å’²ã®æ€’ã‚Šã‚’é®ã‚ã‚‹ã‹ã€èº«ã‚’æŒºã—ã¦æ¢¨å¥ˆã‚’å®ˆã‚‹ã‹ã€ãã‚Œã¨ã‚‚â€¦â€¦ã€‚
                </p>
            `,
            choices: [] // JSã§åˆ†å²ç”Ÿæˆ
        },

        // ============================================================
        // BAD END ROUTE: æ­»äº¡ï¼ˆæ¢¨å¥ˆã‚’åº‡ã†ï¼‰
        // ============================================================
        bad_1_protect: {
            icon: "ğŸ›¡ï¸",
            bg: "bg_archive",
            cg: "", // CGæ¶ˆã™
            text: `
                <p>ã€Œå±ãªã„ï¼ æ¢¨å¥ˆã¡ã‚ƒã‚“ï¼ã€</p>
                <p>ç§ã¯è€ƒãˆã‚‹ã‚ˆã‚Šã‚‚å…ˆã«ä½“ãŒå‹•ã„ã¦ã„ãŸã€‚<br>
                è¨ˆç®—ã‚‚ã€æå¾—ã‚‚ã€å¹½éœŠã¸ã®ææ€–ã‚‚ãªã„ã€‚<br>
                ãŸã ã€ç›®ã®å‰ã®ç”ŸããŸæ¸©ã‚‚ã‚Šã‚’å®ˆã‚ŠãŸã„ä¸€å¿ƒã§ã€‚</p>
                <p>ç§ã¯æ¢¨å¥ˆã«è¦†ã„ã‹ã¶ã•ã‚Šã€å½¼å¥³ã‚’åºŠã¸æŠ¼ã—å€’ã—ãŸã€‚<br>
                ã€Œå…ˆè¼©ï¼ï¼Ÿã€</p>
                <p>ãã®ç¬é–“ã€é ­ä¸Šã§é‡‘å±ãŒã²ã—ã‚ƒã’ã‚‹è½ŸéŸ³ãŒéŸ¿ã„ãŸã€‚</p>
            `,
            choices: [
                { text: "è¡æ’ƒã«å‚™ãˆã‚‹", next: "bad_2_impact" }
            ]
        },
        bad_2_impact: {
            icon: "ğŸ’¥",
            bg: "bg_archive",
            sound: "se_slam",     // â˜…SEï¼šæ‰“æ’ƒéŸ³
            music: "bgm_tinnitus",// â˜…BGMï¼šè€³é³´ã‚Š
            text: `
                <p><span class="ghost-voice">ã€â€¦â€¦è£åˆ‡ãƒƒã‚¿ãƒã€‚äºœä¹…æ–—ã‚¯ãƒ³ã€‚ã€</span></p>
                <p>è€³å…ƒã§ã€ç¾å’²ã®å†·ãŸã„æºœæ¯ãŒèã“ãˆãŸæ°—ãŒã—ãŸã€‚</p>
                <p>ç›´å¾Œã€æ•°ç™¾ã‚­ãƒ­ã®æ›¸é¡æ£šãŒã€ç§ã®èƒŒä¸­ã‚’ç›´æ’ƒã—ãŸã€‚<br>
                <strong>ã‚°ã‚·ãƒ£ãƒƒã€‚</strong><br>
                è„Šæ¤ãŒç •ã‘ã€å†…è‡“ãŒç ´è£‚ã™ã‚‹ã€ç”Ÿã€…ã—ã„éŸ³ã€‚</p>
                <p>ã€ŒãŒã€ã¯ã£â€¦â€¦ï¼ã€<br>
                å£ã‹ã‚‰å¤§é‡ã®è¡€ãŒæº¢ã‚Œå‡ºã—ã€æ¢¨å¥ˆã®ç™½ã„ãƒ–ãƒ©ã‚¦ã‚¹ã‚’èµ¤ãæŸ“ã‚ã‚‹ã€‚<br>
                æ¢¨å¥ˆã®æ‚²é³´ãŒé ãèã“ãˆã‚‹ã€‚</p>
            `,
            choices: [
                { text: "è–„ã‚Œã‚†ãæ„è­˜ã®ä¸­ã§", next: "end_bad" }
            ]
        },
        end_bad: {
            icon: "âš°ï¸",
            bg: "bg_archive", 
            cg: "cg_misaki_ghost_hollow", // â˜…CGï¼šè™šã‚ãªç³ã®ç¾å’²ï¼ˆãŠè¿ãˆï¼‰
            music: "bgm_ending",
            effect: { stopShake: true, redBg: true }, // â˜…åŠ¹æœï¼šç”»é¢ã‚’èµ¤ã
            text: `
                <p>ç—›ã¿ã¯ã™ãã«æ¶ˆãˆãŸã€‚ä»£ã‚ã‚Šã«ã€æ·±ã„é—‡ãŒç§ã‚’åŒ…ã¿è¾¼ã‚€ã€‚</p>
                <p>é—‡ã®å‘ã“ã†ã‹ã‚‰ã€ç¾å’²ãŒæ­©ã„ã¦ãã‚‹ã®ãŒè¦‹ãˆãŸã€‚<br>
                å½¼å¥³ã¯ç¬‘ã£ã¦ã„ãŸã€‚ã¨ã¦ã‚‚å„ªã—ãã€ã¨ã¦ã‚‚æã‚ã—ã„ç¬‘é¡”ã§ã€‚</p>
                <p><span class="ghost-voice">ã€ã‚„ã£ã¨æ¥ã¦ãã‚ŒãŸã­ã€‚å¾…ã£ã¦ãŸã‚ˆã€‚ã€</span></p>
                <p>å½¼å¥³ã®å†·ãŸã„æ‰‹ãŒã€ç§ã®é­‚ã‚’æ´ã‚€ã€‚<br>
                ã‚‚ã†é€ƒã’ã‚‰ã‚Œãªã„ã€‚ç§ãŸã¡ã¯ã€æ­»ã®åº•ã§æ°¸é ã«ä¸€ã¤ã«ãªã‚‹ã®ã ã€‚</p>
                <div class="ending-card" style="border-color:#666; color:#666;">
                    <div class="end-title">BAD END: å¶ç™ºå‚µå‹™ã®å±¥è¡Œ (Death)</div>
                    <p>æ„›ã«æ®‰ã˜ãŸä»£å„Ÿã¯ã€æ°¸é ã®é—‡ã ã£ãŸã€‚</p>
                </div>
            `,
            choices: [
                { text: "ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹", next: "back_to_title" }
            ]
        },

        // ============================================================
        // TRUE END ROUTE: ç”Ÿå­˜ï¼ˆæ¢¨å¥ˆã‚’çªãæ”¾ã™ï¼‰
        // ============================================================
        true_1_act: {
            icon: "ğŸ’”",
            bg: "bg_archive",
            cg: "cg_misaki_ghost_dead", // â˜…CGï¼šç›£è¦–ã™ã‚‹ç¾å’²
            sound: "se_slam", 
            text: `
                <p>æ¢¨å¥ˆã‚’å®ˆã‚‹æ–¹æ³•ã¯ä¸€ã¤ã—ã‹ãªã„ã€‚<br>
                ç¾å’²ï¼ˆéœŠï¼‰ã‚’æº€è¶³ã•ã›ã‚‹ã“ã¨ã€‚<br>
                ã¤ã¾ã‚Šã€ç§ãŒæ¢¨å¥ˆã‚’å¾¹åº•çš„ã«æ‹’çµ¶ã—ã€ç¾å’²ã¸ã®å¿ èª ã‚’ç¤ºã™ã“ã¨ã ã€‚</p>
                <p>ç§ã¯å¿ƒã‚’é¬¼ã«ã—ã¦ã€æ„›ã™ã‚‹å¾Œè¼©ã‚’ç¨ã¿ã¤ã‘ãŸã€‚<br>
                ã€Œâ€¦â€¦å‹˜é•ã„ã—ãªã„ã§ãã‚Œã‚ˆï¼ï¼ã€</p>
                <p>ã€Œãˆâ€¦â€¦ï¼Ÿã€<br>
                æ¢¨å¥ˆãŒæ¶™ç›®ã®ã¾ã¾å‡ã‚Šã¤ãã€‚</p>
            `,
            choices: [
                { text: "æ®‹é…·ãªè¨€è‘‰ã‚’æµ´ã³ã›ã‚‹", next: "true_2_reject" }
            ]
        },
        true_2_reject: {
            icon: "ğŸ¤¬",
            bg: "bg_archive",
            cg: "cg_misaki_ghost_dead",
            text: `
                <p>ã€Œå›ã®ä»•äº‹ãŒé…ã„ã‹ã‚‰æ‰‹ä¼ã£ã¦ãŸã ã‘ã ï¼ è¿·æƒ‘ãªã‚“ã ã‚ˆï¼ã€<br>
                ã€Œä»˜ãåˆã†ï¼Ÿ æœ¬æ°—ã‹ï¼Ÿ ä¿ºã®è©•ä¾¡ãŒä¸‹ãŒã‚‹ã ã‚ï¼ï¼Ÿã€</p>
                <p>ç§ã¯ã‚ã‚Šã‚‚ã—ãªã„æ‚ªæ…‹ã‚’ã¤ãç¶šã‘ãŸã€‚<br>
                è‡ªåˆ†ã®å¿ƒãŒå¼•ãè£‚ã‹ã‚Œã‚‹ã®ã‚’æ„Ÿã˜ãªãŒã‚‰ã€‚</p>
                <p>ã€Œæ¶ˆãˆã‚ï¼ äºŒåº¦ã¨ä¿ºã®å‰ã«é¡”ã‚’è¦‹ã›ã‚‹ãªï¼ã€</p>
                <p>ã€Œâ€¦â€¦ã£ï¼ï¼ã€<br>
                æ¢¨å¥ˆã®ç›®ã‹ã‚‰å¤§ç²’ã®æ¶™ãŒæº¢ã‚Œå‡ºã—ãŸã€‚<br>
                ã€Œã›ã€å…ˆè¼©â€¦â€¦ã²ã©ã„â€¦â€¦ãƒƒï¼ã€<br>
                å½¼å¥³ã¯æ³£ããªãŒã‚‰è³‡æ–™å®¤ã‚’é£›ã³å‡ºã—ã¦ã„ã£ãŸã€‚</p>
            `,
            choices: [
                { text: "é™å¯‚ãŒè¨ªã‚Œã‚‹", next: "end_true" }
            ]
        },
        end_true: {
            icon: "ğŸšï¸",
            bg: "bg_archive",
            cg: "cg_misaki_ghost_hollow", // â˜…CGï¼šæº€è¶³ã’ãªç¾å’²
            music: "bgm_ending",
            effect: { stopShake: true },
            text: `
                <p>å½¼å¥³ã®è¶³éŸ³ãŒé ã–ã‹ã‚‹ã¨åŒæ™‚ã«ã€æ£šã®æºã‚ŒãŒãƒ”ã‚¿ãƒªã¨æ­¢ã¾ã£ãŸã€‚<br>
                è’ã‚Œæœã¦ãŸè³‡æ–™å®¤ã«ã€é™å¯‚ãŒæˆ»ã‚‹ã€‚</p>
                <p><span class="ghost-voice">ã€ã†ã‚“ã€‚ã‚ˆãã§ãã¾ã—ãŸã€‚ã€</span></p>
                <p>è™šç©ºã‹ã‚‰ã€æº€è¶³ã’ãªå£°ãŒéŸ¿ã„ãŸã€‚<br>
                <span class="ghost-voice">ã€ã‚³ãƒ¬ãƒ‡é‚ªé­”è€…ãƒå±…ãƒŠã‚¯ãƒŠãƒƒã‚¿ãƒã€‚ãšã£ã¨ä¸€ç·’ã ã‚ˆã€äºœä¹…æ–—ã‚¯ãƒ³â€¦â€¦ã€</span></p>
                <p>ç§ã¯ãã®å ´ã«å´©ã‚Œè½ã¡ãŸã€‚<br>
                å‘½ã¯åŠ©ã‹ã£ãŸã€‚ã ãŒã€ç§ã¯ä¸€ç”Ÿã€å½¼å¥³ã®å‘ªã„ã¨å…±ã«ç”Ÿãã¦ã„ãã€‚<br>
                èª°ã¨ã‚‚çµã°ã‚Œãšã€èª°ã‚‚æ„›ã•ãšã€ãŸã éå»ã®äº¡éœŠã«ç›£è¦–ã•ã‚ŒãªãŒã‚‰ã€‚<br>
                ãã‚ŒãŒã€ç”Ÿãæ®‹ã£ãŸç§ã®å—ã‘ã‚‹ç½°ãªã®ã ã€‚</p>
                <div class="ending-card" style="border-color:#4a90e2; color:#4a90e2;">
                    <div class="end-title">TRUE END: é€£çµæ±ºç®— (Possession)</div>
                    <p>æœªç·´ã¨ã„ã†è² å‚µã¯ã€å®Œæ¸ˆã•ã‚Œã‚‹ã“ã¨ãŒãªã„ã€‚</p>
                </div>
            `,
            choices: [
                { text: "ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¸æˆ»ã‚‹", next: "back_to_title" }
            ]
        },

        // ============================================================
        // DARK END ROUTE: æ‚ªé­”ï¼ˆæ¢¨å¥ˆã‚’ç”Ÿè´„ã«ã™ã‚‹ï¼‰
        // ============================================================
        dark_1_push: {
            icon: "ğŸ˜ˆ",
            bg: "bg_archive",
            cg: "cg_misaki_ghost_hollow", // â˜…CGï¼šèª˜æƒ‘ã™ã‚‹ç¾å’²
            text: `
                <p>ãµã¤ãµã¤ã¨ã€é»’ã„æ„Ÿæƒ…ãŒæ¹§ãä¸ŠãŒã£ã¦ãã‚‹ã€‚<br>
                å¾©è®ã®å¿«æ„Ÿã‚’çŸ¥ã£ã¦ã—ã¾ã£ãŸç§ã®å¿ƒã¯ã€æ—¢ã«äººé–“ã®ã‚‚ã®ã§ã¯ãªããªã£ã¦ã„ãŸã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚</p>
                <p>ç›®ã®å‰ã§æ€¯ãˆã‚‹æ¢¨å¥ˆãŒã€ãŸã ã®ã€Œéšœå®³ç‰©ã€ã«è¦‹ãˆãŸã€‚</p>
                <p>ã€Œç¾å’²ã€‚â€¦â€¦æ–°ã—ã„ãŠã‚‚ã¡ã‚ƒã ã‚ˆã€</p>
                <p>ç§ã¯å¾®ç¬‘ã‚“ã§ã€è…°ã‚’æŠœã‹ã—ã¦ã„ã‚‹æ¢¨å¥ˆã«è¿‘ã¥ã„ãŸã€‚<br>
                ã€Œå…ˆè¼©â€¦â€¦ï¼Ÿ ä½•ã‚’â€¦â€¦ã€</p>
            `,
            choices: [
                { text: "å½¼å¥³ã‚’çªãé£›ã°ã™", next: "dark_2_sacrifice" }
            ]
        },
        dark_2_sacrifice: {
            icon: "ğŸ©¸",
            bg: "bg_archive",
            sound: "se_execution", // â˜…SEï¼šå‡¦åˆ‘éŸ³
            text: `
                <p>ç§ã¯æ¢¨å¥ˆã®è‚©ã‚’ã€æ€ã„åˆ‡ã‚Šè¹´ã‚Šé£›ã°ã—ãŸã€‚</p>
                <p>ã€Œãã‚ƒã‚ã£ï¼ï¼Ÿã€<br>
                å½¼å¥³ã¯ç„¡é˜²å‚™ã«å€’ã‚Œè¾¼ã‚€ã€‚<br>
                ãã®ä½ç½®ã¯ã€å‚¾ã„ã¦ã„ãŸå·¨å¤§ãªã‚¹ãƒãƒ¼ãƒ«æ£šã®çœŸä¸‹ã ã£ãŸã€‚</p>
                <p><span class="highlight">ãƒ‰ã‚©ã‚©ã‚©ã‚©ãƒ³ï¼ï¼ï¼</span></p>
                <p>éˆã„éŸ³ã€‚çŸ­ã„æ‚²é³´ã€‚ãã—ã¦ã€éª¨ãŒç •ã‘ã‚‹éŸ³ã€‚<br>
                åºŠã«åºƒãŒã£ãŸæ›¸é¡ãŒã€æ€¥é€Ÿã«èµ¤é»’ãæŸ“ã¾ã£ã¦ã„ãã€‚</p>
                <p>ã€Œã‚â€¦â€¦ã‚â€¦â€¦ã€<br>
                æ£šã®ä¸‹ã‹ã‚‰ã€ç—™æ”£ã™ã‚‹ç™½ã„æ‰‹ãŒã¯ã¿å‡ºã—ã¦ã„ãŸã€‚</p>
            `,
            choices: [
                { text: "é«˜ç¬‘ã„ã™ã‚‹", next: "end_dark" }
            ]
        },
        end_dark: {
            icon: "ğŸ‘ï¸",
            bg: "bg_archive",
            cg: "cg_misaki_ghost_dead", // â˜…CGï¼šç‹‚æ°—ã®ç¾å’²
            music: "bgm_ending",
            effect: { stopShake: true, redBg: true },
            text: `
                <p>ç§ã¯ãã‚Œã‚’è¦‹ä¸‹ã‚ã—ãªãŒã‚‰ã€è…¹ã®åº•ã‹ã‚‰ç¬‘ã„å‡ºã—ãŸã€‚<br>
                ç½ªæ‚ªæ„Ÿï¼Ÿ ã„ã„ã‚„ã€æ„Ÿã˜ã‚‹ã®ã¯å…¨èƒ½æ„Ÿã ã€‚</p>
                <p><span class="ghost-voice">ã€ã‚¢ãƒãƒãƒãƒï¼ æœ€é«˜ï¼ ç§é”ã€æœ¬å½“ãƒ‹ä¸€ãƒ„ãƒ‹ãƒŠãƒ¬ã‚¿ãƒï¼ã€</span></p>
                <p>ç¾å’²ã®ç‹‚æ°—ãŒã€ç§ã®ä¸­ã«æµã‚Œè¾¼ã‚“ã§ãã‚‹ã€‚<br>
                è‰¯å¿ƒã‚‚ã€äººé–“æ€§ã‚‚æ¨ã¦å»ã‚Šã€ç§ã¯ã“ã®ä¼šç¤¾ã®ã€Œæ­»ç¥ã€ã¨ãªã£ãŸã®ã ã€‚</p>
                <p>ç¿Œå¹´ã®4æœˆã€‚<br>
                ç§ã¯çµŒç†ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¨ã—ã¦ã€éœ‡ãˆã‚‹æ–°å…¥ç¤¾å“¡ã«å‘ã‹ã£ã¦å¾®ç¬‘ã‚€ã€‚</p>
                <p>ã€Œã‚ˆã†ã“ãã€‚å›ã®äººç”Ÿã€<span class="highlight">åƒ•ãŸã¡</span>ãŒç®¡ç†ã—ã¦ã‚ã’ã‚‹ã‚ˆã€</p>
                <div class="ending-card" style="border-color:#b00; color:#b00;">
                    <div class="end-title">DARK END: æ‚ªé­”åˆä½“ (The Manager)</div>
                    <p>äºˆå®Ÿã¯çµ±åˆã•ã‚ŒãŸã€‚ç‹‚æ°—ã¨ã„ã†åã®é»’å­—æ±ºç®—ã§ã€‚</p>
                </div>
            `,
            choices: [
                { text: "ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹", next: "back_to_title" }
            ]
        }
    };

    // â–¼â–¼â–¼ ã‚¨ãƒ³ã‚¸ãƒ³éƒ¨ â–¼â–¼â–¼
    const dom = {
        text: document.getElementById("narrative-area"),
        choices: document.getElementById("choices-container"),
        wrapper: document.getElementById("game-wrapper"),
        popup: document.getElementById("final-popup"),
        popupMsg: document.getElementById("popup-msg")
    };

    // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    const savedData = JSON.parse(localStorage.getItem("yojitsu_save")) || { karma: 0 };

    function render(sceneId) {
        window.scrollTo(0, 0);
        document.getElementById("game-wrapper").scrollTop = 0;

        if(sceneId === "back_to_title") {
            window.location.href = "index.html";
            return;
        }

        const scene = scenes[sceneId];
        
        // --- 1. ç”»åƒãƒ»éŸ³å£°åˆ¶å¾¡ ---
        if(scene) {
            visuals.setBg(scene.bg);
            visuals.setCg(scene.cg);
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚‚èƒŒæ™¯ç”»åƒã‚’è¨­å®š
            if(scene.bg) {
                document.getElementById("visual-stage").style.backgroundImage = `url('images/${scene.bg}.jpg')`;
            }
            
            if(scene.music === "stop") audio.stopBgm();
            else if(scene.music) audio.playBgm(scene.music);

            if(scene.sound) audio.playSe(scene.sound);
        }

        // --- 2. æœ€çµ‚åˆ†å²ç”Ÿæˆï¼ˆã‚«ãƒ«ãƒå€¤ã§å¤‰åŒ–ï¼‰ ---
        if (sceneId === "ultimatum") {
            const c = [];
            c.push({ text: "ã€Œå±ãªã„ï¼ã€ã¨å«ã‚“ã§æ¢¨å¥ˆã‚’åº‡ã†", next: "bad_1_protect", class: "btn-bad" });
            c.push({ text: "ã€Œè¿·æƒ‘ãªã‚“ã ã‚ˆï¼ã€ã¨ç½µå€’ã—ã¦æ¢¨å¥ˆã‚’é ã–ã‘ã‚‹", next: "true_1_act", class: "btn-true" });
            
            // å¾©è®ãƒ«ãƒ¼ãƒˆé€šéæ¸ˆã¿ï¼ˆã‚«ãƒ«ãƒãŒé«˜ã„ï¼‰ãªã‚‰æ®ºæ„ãƒ«ãƒ¼ãƒˆè§£æ”¾
            if (savedData.karma >= 50) {
                c.push({ text: "ã€æ®ºæ„ã€‘æ¢¨å¥ˆã‚’è¹´ã‚Šé£›ã°ã—ã€ç¾å’²ã«æ§ã’ã‚‹", next: "dark_1_push", class: "btn-dark" });
            }
            scenes["ultimatum"].choices = c;
        }

        // --- 3. æ¼”å‡ºå‡¦ç† ---
        if (scene.action && scene.action.popup) {
            dom.popupMsg.innerHTML = scene.action.popup;
            dom.popup.classList.add("show");
        }
        if (scene.action && scene.action.shake) {
            dom.wrapper.classList.add("shake-effect");
        }
        if (scene.effect) {
            if(scene.effect.stopShake) dom.wrapper.classList.remove("shake-effect");
            if(scene.effect.redBg) {
                // èƒŒæ™¯ã‚’èµ¤ãæŸ“ã‚ã‚‹
                document.getElementById("bg-layer").style.backgroundColor = "#500";
                document.getElementById("bg-layer").style.backgroundBlendMode = "multiply";
            }
        }

        // --- 4. ç”»é¢æç”» ---
        dom.text.innerHTML = scene.text;
        dom.text.animate([{opacity:0}, {opacity:1}], {duration: 1000, fill:"forwards"});

        dom.choices.innerHTML = "";
        if (scene.choices) {
            scene.choices.forEach(c => {
                const btn = document.createElement("button");
                btn.innerText = c.text;
                if(c.class) btn.className = c.class;
                btn.onclick = () => render(c.next);
                dom.choices.appendChild(btn);
            });
        }
    }

    render("start");

</script>
</body>
</html>